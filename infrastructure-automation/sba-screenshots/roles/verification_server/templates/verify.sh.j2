#!/bin/bash

MAGIC="48"
DOMAIN="yellow.lab"
PRIMARY_IP="172.16.30.48"
ALIAS_IP="172.16.32.48"
NFS_EXPORT="/srv/nfs"

USER1="user1"
USER1_PASS="user1"
USER2="user2"
USER2_PASS="user2"

LOG_FILE="/root/verification.log"

exec > >(tee -a "$LOG_FILE") 2>&1

# =============================
echo "== Creating mount points =="
# =============================
sudo mkdir -p /mnt/{pub-u1,priv-u1,pub-u2,priv-u2,nfs}
sudo chmod -R 777 /mnt/nfs

# =============================
echo -e "\n=== Mounting Samba shares ==="
# =============================
sudo mount -t cifs //${PRIMARY_IP}/samba-public  /mnt/pub-u1 \
    -o username=${USER1},password=${USER1_PASS},file_mode=0777,dir_mode=0777

sudo mount -t cifs //${PRIMARY_IP}/samba-private /mnt/priv-u1 \
    -o username=${USER1},password=${USER1_PASS},file_mode=0777,dir_mode=0777

sudo mount -t cifs //${PRIMARY_IP}/samba-public  /mnt/pub-u2 \
    -o username=${USER2},password=${USER2_PASS},file_mode=0777,dir_mode=0777

sudo mount -t cifs //${PRIMARY_IP}/samba-private /mnt/priv-u2 \
    -o username=${USER2},password=${USER2_PASS},file_mode=0777,dir_mode=0777

# =============================
echo "== Mounting NFS share =="
# =============================
sudo mount -t nfs ${PRIMARY_IP}:${NFS_EXPORT} /mnt/nfs

# =============================
echo "== Writing to shares =="
# =============================
echo "Hello from ${USER1} public"  > /mnt/pub-u1/u1_pub.txt
echo "Hello from ${USER1} private" > /mnt/priv-u1/u1_priv.txt
echo "Hello from ${USER2} public"  > /mnt/pub-u2/u2_pub.txt

echo "Trying to write as ${USER2} to private (should fail)"
echo "Hello from ${USER2} private" > /mnt/priv-u2/u2_priv.txt 2>/mnt/priv-u2/u2_priv_error.log \
    || echo "Permission denied as expected"

echo "Writing to NFS"
echo "Hello from dont work server" > /mnt/nfs/nfs_test.txt

# =============================
echo "== Results =="
# =============================
echo "--- /mnt/pub-u1/u1_pub.txt ---"
cat /mnt/pub-u1/u1_pub.txt

echo "--- /mnt/priv-u1/u1_priv.txt ---"
cat /mnt/priv-u1/u1_priv.txt

echo "--- /mnt/pub-u2/u2_pub.txt ---"
cat /mnt/pub-u2/u2_pub.txt

echo "--- /mnt/priv-u2/u2_priv.txt (should fail or be empty) ---"
cat /mnt/priv-u2/u2_priv.txt 2>/dev/null || echo "[Failed to read]"

echo "--- /mnt/nfs/nfs_test.txt ---"
cat /mnt/nfs/nfs_test.txt

# =============================
echo "== iptables rules =="
# =============================
sudo iptables -L -n -v


echo "== Done =="

